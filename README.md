# blog-search

## 기능 요구사항

1. 블로그 검색

- 키워드를 통해 블로그를 검색할 수 있어야 합니다.

- 검색 결과에서 Sorting(정확도순, 최신순) 기능을 지원해야 합니다.

- 검색 결과는 Pagination 형태로 제공해야 합니다.

- 검색 소스는 카카오 API의 키워드로 블로그 검색(https://developers.kakao.com/docs/latest/ko/daum-search/dev-guide#search-blog)을 활용합니다.

- 추후 카카오 API 이외에 새로운 검색 소스가 추가될 수 있음을 고려해야 합니다.

2. 인기 검색어 목록

- 사용자들이 많이 검색한 순서대로, 최대 10개의 검색 키워드를 제공합니다.

- 검색어 별로 검색된 횟수도 함께 표기해 주세요.

- 주어진 요구사항 이외의 추가 기능 구현에 대한 제약은 없으며, 새롭게 구현한 기능이 있을 경우 README 파일에 기재 바랍니다.

## 개발 환경

- Java 17
- Spring Boot 3.2.1
- Gradle 8.5
- JPA
- QueryDSL

## 외부 라이브러리 목록

| Dependency                                          | Version | Purpose                                                            |
| ---------------------------------------------------- | ------- | ------------------------------------------------------------------ |
| org.mapstruct:mapstruct:                            | 1.5.5   | dto <-> entity 변환용 mapstruct 라이브러리                               |
| com.h2database:h2                                   | 2.1.214 | 테스트용 인메모리 데이터베이스 라이브러리                                 |
| com.querydsl:querydsl-jpa                            | 5.0.0   | JPA를 사용하여 타입 안전한 쿼리를 작성할 수 있게 도와주는 라이브러리    |
| com.querydsl:querydsl-apt                            | 5.0.0   | Querydsl을 사용하기 위한 애노테이션 프로세서 라이브러리                 |

| Test Dependency                                     | Version | Purpose                                        |
| ---------------------------------------------------- | ------- | ---------------------------------------------- |
| com.h2database:h2                                   | 2.1.214 | 테스트용 인메모리 데이터베이스 라이브러리             |

## 고려사항

### 다수의 사용자가 동시에 검색을 요청하는 경우 동시성 문제 발생

블로그 검색 시 키워드의 검색 횟수를 증가하거나 새로운 키워드를 저장할 때 동일한 자원에 동시에 접근하게 되면 동시성 문제가 발생할 수 있다고 판단했습니다.

-> Redisson 분산 락을 활용하여 동시성 문제를 해결하였습니다.
  - AOP를 활용하여 서비스에서의 Redisson 의존성을 최소화하였습니다.
  - @DistributeLock 이 선언된 메서드는 Propagation.REQUIRES_NEW 옵션을 지정해 별도의 트랜잭션으로 동작하게끔 설정하여 반드시 트랜잭션 커밋 이후 락이 해제되게끔 처리했습니다.

Reddison vs Lettuce
- Redisson에서는 분산락을 이미 구현하여 제공하고 있으므로, 별도의 구현 로직이 필요하지 않다.
- Pub/Sub 기반으로 동작하여 기존 Lettuce를 통한 스핀락 기반의 분산락에 비해 Redis에 부하를 덜 준다.



### 블로그 검색과 검색어 저장 간의 역할 분리

블로그 검색 기능에서 블로그 검색과 검색어 저장을 모두 맡아서 하는 것은 단일 책임 원칙을 지키지 못한다고 판단하였습니다.

Spring Event를 활용하여 블로그 검색과 검색어 저장/검색 횟수 업데이트를 분리하였습니다.

또한, 블로그 검색과 검색어 저장/검색 횟수 업데이트를 비동기로 처리하도록 구현하여 처리 속도를 개선하였습니다.



### 장애 대비 및 새로운 검색 소스 확정성 고려

@Retryable과 @Recover를 활용하여 카카오 블로그 검색 장애 발생 시 네이버 블로그 검색이 가능하도록 설계하였습니다.

디폴트 검색 기능인 카카오 API를 기준으로 공통된 필드를 추출하고 인터페이스로 추상화하여 새로운 검색 소스에 의한 확장에 고려한 설계를 하였습니다.

```
public interface ApiResponse {

    List<Document> getDocuments();

    Meta getMeta();
}
```

## API 명세서

http://localhost:8080/docs/.html

